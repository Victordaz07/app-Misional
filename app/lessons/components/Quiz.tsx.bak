import React, { useState } from 'react';
import {
    View,
    Text,
    StyleSheet,
    TouchableOpacity,
    ScrollView,
    Alert,
} from 'react-native';
import { useI18n } from '../../../context/I18nContext';

interface QuizQuestion {
    id: string;
    question: string;
    options: string[];
    correctAnswer: number;
    explanation?: string;
}

interface QuizProps {
    questions: QuizQuestion[];
    onComplete: (score: number, totalQuestions: number) => void;
}

export default function Quiz({ questions, onComplete }: QuizProps) {
    const { t } = useI18n();
    const [currentQuestion, setCurrentQuestion] = useState(0);
    const [selectedAnswers, setSelectedAnswers] = useState<number[]>([]);
    const [showResults, setShowResults] = useState(false);
    const [score, setScore] = useState(0);

    const handleAnswerSelect = (answerIndex: number) => {
        const newAnswers = [...selectedAnswers];
        newAnswers[currentQuestion] = answerIndex;
        setSelectedAnswers(newAnswers);
    };

    const handleNext = () => {
        if (currentQuestion < questions.length - 1) {
            setCurrentQuestion(currentQuestion + 1);
        } else {
            // Calculate score
            let correctAnswers = 0;
            questions.forEach((question, index) => {
                if (selectedAnswers[index] === question.correctAnswer) {
                    correctAnswers++;
                }
            });
            setScore(correctAnswers);
            setShowResults(true);
        }
    };

    const handlePrevious = () => {
        if (currentQuestion > 0) {
            setCurrentQuestion(currentQuestion - 1);
        }
    };

    const handleFinishQuiz = () => {
        onComplete(score, questions.length);
    };

    const getScoreColor = () => {
        const percentage = (score / questions.length) * 100;
        if (percentage >= 80) return '#10b981'; // Green
        if (percentage >= 60) return '#f59e0b'; // Yellow
        return '#ef4444'; // Red
    };

    const getScoreMessage = () => {
        const percentage = (score / questions.length) * 100;
        if (percentage >= 80) return t('quiz.excellent');
        if (percentage >= 60) return t('quiz.good');
        return t('quiz.needsImprovement');
    };

    if (showResults) {
        return (
            <View style={styles.container}>
                <View style={styles.resultsContainer}>
                    <Text style={styles.resultsTitle}>{t('quiz.results')}</Text>
                    <View style={[styles.scoreContainer, { backgroundColor: getScoreColor() }]}>
                        <Text style={styles.scoreText}>
                            {score} / {questions.length}
                        </Text>
                        <Text style={styles.scorePercentage}>
                            {Math.round((score / questions.length) * 100)}%
                        </Text>
                    </View>
                    <Text style={styles.scoreMessage}>{getScoreMessage()}</Text>

                    <ScrollView style={styles.explanationsContainer}>
                        {questions.map((question, index) => (
                            <View key={question.id} style={styles.explanationItem}>
                                <Text style={styles.questionText}>{question.question}</Text>
                                <Text style={styles.correctAnswer}>
                                    {t('quiz.correctAnswer')}: {question.options[question.correctAnswer]}
                                </Text>
                                {selectedAnswers[index] !== question.correctAnswer && (
                                    <Text style={styles.yourAnswer}>
                                        {t('quiz.yourAnswer')}: {question.options[selectedAnswers[index] || 0]}
                                    </Text>
                                )}
                                {question.explanation && (
                                    <Text style={styles.explanation}>{question.explanation}</Text>
                                )}
                            </View>
                        ))}
                    </ScrollView>

                    <TouchableOpacity style={styles.finishButton} onPress={handleFinishQuiz}>
                        <Text style={styles.finishButtonText}>{t('quiz.finish')}</Text>
                    </TouchableOpacity>
                </View>
            </View>
        );
    }

    const question = questions[currentQuestion];
    const isAnswered = selectedAnswers[currentQuestion] !== undefined;

    return (
        <View style={styles.container}>
            <View style={styles.header}>
                <Text style={styles.questionCounter}>
                    {t('quiz.question')} {currentQuestion + 1} {t('quiz.of')} {questions.length}
                </Text>
                <View style={styles.progressBar}>
                    <View
                        style={[
                            styles.progressFill,
                            { width: `${((currentQuestion + 1) / questions.length) * 100}%` }
                        ]}
                    />
                </View>
            </View>

            <View style={styles.questionContainer}>
                <Text style={styles.questionText}>{question.question}</Text>

                <View style={styles.optionsContainer}>
                    {question.options.map((option, index) => (
                        <TouchableOpacity
                            key={index}
                            style={[
                                styles.optionButton,
                                selectedAnswers[currentQuestion] === index && styles.selectedOption
                            ]}
                            onPress={() => handleAnswerSelect(index)}
                        >
                            <Text style={[
                                styles.optionText,
                                selectedAnswers[currentQuestion] === index && styles.selectedOptionText
                            ]}>
                                {option}
                            </Text>
                        </TouchableOpacity>
                    ))}
                </View>
            </View>

            <View style={styles.navigationContainer}>
                {currentQuestion > 0 && (
                    <TouchableOpacity style={styles.previousButton} onPress={handlePrevious}>
                        <Text style={styles.previousButtonText}>{t('quiz.previous')}</Text>
                    </TouchableOpacity>
                )}

                <TouchableOpacity
                    style={[styles.nextButton, !isAnswered && styles.disabledButton]}
                    onPress={handleNext}
                    disabled={!isAnswered}
                >
                    <Text style={styles.nextButtonText}>
                        {currentQuestion === questions.length - 1 ? t('quiz.finish') : t('quiz.next')}
                    </Text>
                </TouchableOpacity>
            </View>
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: '#f9fafb',
        padding: 20,
    },
    header: {
        marginBottom: 24,
    },
    questionCounter: {
        fontSize: 16,
        color: '#6b7280',
        textAlign: 'center',
        marginBottom: 12,
    },
    progressBar: {
        height: 4,
        backgroundColor: '#e5e7eb',
        borderRadius: 2,
    },
    progressFill: {
        height: '100%',
        backgroundColor: '#3b82f6',
        borderRadius: 2,
    },
    questionContainer: {
        flex: 1,
    },
    questionText: {
        fontSize: 20,
        fontWeight: '600',
        color: '#1f2937',
        marginBottom: 24,
        textAlign: 'center',
        lineHeight: 28,
    },
    optionsContainer: {
        gap: 12,
    },
    optionButton: {
        backgroundColor: '#ffffff',
        borderRadius: 12,
        padding: 16,
        borderWidth: 2,
        borderColor: '#e5e7eb',
        shadowColor: '#000',
        shadowOpacity: 0.05,
        shadowRadius: 4,
        elevation: 2,
    },
    selectedOption: {
        borderColor: '#3b82f6',
        backgroundColor: '#eff6ff',
    },
    optionText: {
        fontSize: 16,
        color: '#374151',
        textAlign: 'center',
    },
    selectedOptionText: {
        color: '#1d4ed8',
        fontWeight: '600',
    },
    navigationContainer: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        marginTop: 24,
    },
    previousButton: {
        backgroundColor: '#6b7280',
        borderRadius: 12,
        paddingVertical: 16,
        paddingHorizontal: 24,
        flex: 0.4,
    },
    previousButtonText: {
        color: '#ffffff',
        fontSize: 16,
        fontWeight: '600',
        textAlign: 'center',
    },
    nextButton: {
        backgroundColor: '#3b82f6',
        borderRadius: 12,
        paddingVertical: 16,
        paddingHorizontal: 24,
        flex: 0.55,
    },
    disabledButton: {
        backgroundColor: '#9ca3af',
    },
    nextButtonText: {
        color: '#ffffff',
        fontSize: 16,
        fontWeight: '600',
        textAlign: 'center',
    },
    resultsContainer: {
        flex: 1,
    },
    resultsTitle: {
        fontSize: 24,
        fontWeight: '700',
        color: '#1f2937',
        textAlign: 'center',
        marginBottom: 24,
    },
    scoreContainer: {
        borderRadius: 16,
        padding: 24,
        alignItems: 'center',
        marginBottom: 16,
    },
    scoreText: {
        fontSize: 32,
        fontWeight: '700',
        color: '#ffffff',
        marginBottom: 4,
    },
    scorePercentage: {
        fontSize: 18,
        color: '#ffffff',
        opacity: 0.9,
    },
    scoreMessage: {
        fontSize: 18,
        fontWeight: '600',
        color: '#1f2937',
        textAlign: 'center',
        marginBottom: 24,
    },
    explanationsContainer: {
        flex: 1,
        marginBottom: 24,
    },
    explanationItem: {
        backgroundColor: '#ffffff',
        borderRadius: 12,
        padding: 16,
        marginBottom: 12,
        borderLeftWidth: 4,
        borderLeftColor: '#3b82f6',
    },
    correctAnswer: {
        fontSize: 14,
        color: '#10b981',
        fontWeight: '600',
        marginTop: 8,
    },
    yourAnswer: {
        fontSize: 14,
        color: '#ef4444',
        fontWeight: '600',
        marginTop: 4,
    },
    explanation: {
        fontSize: 14,
        color: '#6b7280',
        marginTop: 8,
        fontStyle: 'italic',
    },
    finishButton: {
        backgroundColor: '#10b981',
        borderRadius: 12,
        paddingVertical: 16,
        paddingHorizontal: 24,
        alignItems: 'center',
    },
    finishButtonText: {
        color: '#ffffff',
        fontSize: 16,
        fontWeight: '600',
    },
});
